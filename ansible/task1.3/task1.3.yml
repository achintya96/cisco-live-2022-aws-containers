- name: Playbook for Task1 Step7 - creating the ACI objects for single page attachment
  hosts: apic1
  gather_facts: no
  vars_files: inventory.yml
  connection: httpapi

  tasks:

    - name: Create a BD for the frontend tier
      cisco.aci.aci_bd:
        host: '{{ apic_host }}'
        username: '{{ apic_username }}'
        password: '{{ apic_pass }}'
        tenant: '{{ apic_tenant }}'
        vrf: 'CLUS_VRF'
        bd: 'BD_Frontend'
        validate_certs: no
        state: present

    - name: Create frontend subnet
      cisco.aci.aci_bd_subnet:
        host: '{{ apic_host }}'
        username: '{{ apic_username }}'
        password: '{{ apic_pass }}'
        tenant: '{{ apic_tenant }}'
        bd: BD_Frontend
        subnet_name: frontend_subnet
        gateway: 30.0.1.1
        mask: 24
        validate_certs: no
        state: present

    - name: Create an AP
      cisco.aci.aci_ap:
        host: '{{ apic_host }}'
        username: '{{ apic_username }}'
        password: '{{ apic_pass }}'
        tenant: '{{ apic_tenant }}'
        ap: CLUS_user01_AP
        validate_certs: no
        state: present  

    - name: Create frontend EPG
      cisco.aci.aci_epg:
        host: '{{ apic_host }}'
        username: '{{ apic_username }}'
        password: '{{ apic_pass }}'
        tenant: '{{ apic_tenant }}'
        bd: BD_Frontend
        ap: CLUS_user01_AP
        epg: EPG_Frontend
        validate_certs: no
        state: present  

    - name: Attach the VMM domain to the created EPGs
      cisco.aci.aci_epg_to_domain:
        host: '{{ apic_host }}'
        username: '{{ apic_username }}'
        password: '{{ apic_pass }}'
        tenant: '{{ apic_tenant }}'
        ap: CLUS_user01_AP
        epg: EPG_Frontend
        domain: nyc-dvs
        domain_type: vmm
        vm_provider: vmware
        enhanced_lag_policy: nyc-lag
        validate_certs: no